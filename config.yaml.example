# ----------------------------------------------------
# BLE Scanner Settings
# ----------------------------------------------------
scanner:
  # Time in seconds between the start of each scan cycle.
  # Default: 10
  cycle: 10

  # Time in seconds the scanner will actively listen for BLE advertisements.
  # This value must be less than or equal to `cycle`.
  # Default: 3
  duration: 3

  # Bluetooth adapter number to use (e.g., 0 for hci0).
  # Default: 0
  interface: 0

  # Enable or disable the BLE scanner.
  # Set to `false` to disable the scanner, useful in environments without Bluetooth.
  # Default: true
  enabled: true

# ----------------------------------------------------
# Device Definitions (Optional)
# ----------------------------------------------------
# Define reusable devices here to avoid repetition in automations.
# This is useful for devices that require specific constructor parameters
# like a password or a custom retry count.
devices:
  my-sensor:
    address: "11:22:33:44:55:66"
  living-room-curtain:
    address: "55:66:77:88:99:aa"
  window-sensor:
    address: "ab:ab:ab:ab:ab:ab"
  living-room-ac:
    address: "ac:ac:ac:ac:ac:ac" # e.g. a Hub 2 controlling an AC
  front-door-lock:
    address: "aa:bb:cc:dd:ee:ff"
    # `config` specifies constructor arguments for the device.
    # which are passed to the underlying pySwitchbot library.
    config:
      key_id: "xxx"
      encryption_key: "xxx"

# ----------------------------------------------------
# Automations
# ----------------------------------------------------
automations:
  - name: "Turn on Fan when Temperature Rises"
    # Optional: Mutes this automation for 10 minutes after it triggers.
    cooldown: "10m"
    # "if" block: Defines the trigger and conditions.
    if:
      # Source of the event. "switchbot" for real-time state changes.
      source: "switchbot"
      # Conditions to identify the target device(s) and their state.
      conditions:
        modelName: "WoSensorTH"
        # Triggers when the temperature is greater than 28.
        temperature: "> 28.0"
    # "then" block: Defines the action to be executed.
    then:
      # For debugging, the 'log' action is recommended.
      type: "log"
      level: "INFO"
      message: "High temperature detected ({temperature}â„ƒ), turning on fan..."

  - name: "Lock Door if AC is On and Window is Open"
    if:
      # This rule triggers when the window sensor reports being open.
      source: "switchbot"
      device: "window-sensor"
      conditions:
        contact_open: True
        # This condition checks the state of *another* device at the same time.
        # It checks if the device with alias 'living-room-ac' has its 'power'
        # attribute set to "on".
        living-room-ac.power: "on"
    then:
      # If both conditions are true, send a lock command to the front door lock.
      type: "switchbot_command"
      device: "front-door-lock"
      command: "lock"

  - name: "Log Temperature Info"
    # This automation demonstrates the new 'log' action.
    if:
      source: "switchbot"
      conditions:
        modelName: "WoSensorTH"
        temperature: "> 25.0"
    then:
      type: "log"
      # The message supports placeholders, just like other actions.
      message: "Current temperature is {temperature}C, humidity is {humidity}%"
      # Optional: Specify the log level. Defaults to INFO.
      level: "INFO"

  - name: "Execute Shell Command Example"
    if:
      source: "switchbot"
      conditions:
        modelName: "WoBot"
        isOn: True
    then:
      type: "shell_command"
      command: ["echo", "Button pressed at {timestamp}"]

  - name: "Button Press Notification"
    # Mute for 2 seconds to prevent bouncing/chattering effects.
    cooldown: "2s"
    if:
      source: "switchbot"
      conditions:
        modelName: "WoHand"
        address: "XX:XX:XX:XX:XX:AA"
        isOn: True
    then:
      type: "webhook"
      url: "https://example.com/notify"
      payload:
        message: "Button on device {address} was pressed."
      # Optional: Add custom headers for authentication, etc.
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer YOUR_SECRET_TOKEN"

  - name: "Turn off Lights if No Motion for 5 Minutes"
    if:
      # To create a timer-based trigger, add the `duration` key.
      # The action will run only if the conditions are met continuously
      # for the specified duration.
      source: "switchbot"
      duration: "5m"
      conditions:
        modelName: "WoPresence"
        address: "YY:YY:YY:YY:YY:BB"
        motion_detected: False
    then:
      type: "log"
      message: "No motion for 5 minutes, turning off lights."

  - name: "Alert if Door is Open for 10 Minutes"
    cooldown: "1h"
    if:
      source: "switchbot"
      duration: "10m"
      conditions:
        modelName: "WoContact"
        contact_open: True
    then:
      type: "webhook"
      url: "https://example.com/alert"
      payload:
        message: "Warning: Device {address} has been open for 10 minutes!"

  - name: "Control Light via MQTT"
    if:
      source: "mqtt"
      topic: "home/living/light/set"
      conditions:
        # Evaluates the entire payload of the MQTT message.
        payload: "ON"
    then:
      type: "log"
      message: "Turning light ON via MQTT"

  - name: "React to JSON payload from MQTT"
    if:
      source: "mqtt"
      topic: "home/sensors/thermostat"
      conditions:
        # Evaluates a key within a JSON payload.
        temperature: "> 22.0"
    then:
      type: "mqtt_publish"
      topic: "home/living/ac/set"
      payload:
        # The payload can be a dictionary.
        # Placeholders like {temperature} will be replaced with the actual values.
        action: "set_temperature"
        value: "{temperature}"
      # Optional QoS and retain flags
      qos: 1
      retain: true

  - name: "Detect Button Press via State Change"
    # This automation demonstrates how to use the 'previous' state to detect an
    # event, like a button press. It triggers when a value changes from its
    # last known state.
    cooldown: "2s" # A short cooldown to prevent accidental double-presses.
    if:
      source: "switchbot"
      conditions:
        # Target a device that has a button, like a Contact Sensor or Bot.
        modelName: "WoContact"
        # The condition checks if the current 'button_count' is different from
        # the 'previous.button_count'. This is a reliable way to detect a press.
        button_count: "!= {previous.button_count}"
    then:
      type: "webhook"
      url: "https://example.com/notify"
      payload:
        message: "Button on device {address} was pressed!"

  - name: "Notify if MQTT sensor is offline for 5 minutes"
    if:
      source: "mqtt_timer"
      duration: "5m"
      topic: "home/sensors/+/status"
      conditions:
        payload: "offline"
    then:
      type: "webhook"
      url: "https://example.com/alert"
      payload:
        message: "Sensor at topic {topic} is offline!"

  - name: "Press a SwitchBot Bot (Self-Contained)"
    if:
      source: "switchbot"
      conditions:
        modelName: "WoContact"
        contact_open: True
    then:
      # Directly control another SwitchBot device without a top-level definition.
      # This is useful for simple, one-off actions.
      type: "switchbot_command"
      # The MAC address of the target SwitchBot Bot.
      address: "XX:XX:XX:XX:XX:CC"
      # The command to execute. Must match a method in the pyswitchbot library.
      command: "press"

  - name: "Open Curtains if Room is Bright (Reference)"
    if:
      source: "switchbot"
      conditions:
        modelName: "WoContact"
        # Trigger when the light sensor detects a bright environment.
        is_light: True
    then:
      type: "switchbot_command"
      # Reference a device from the `devices` section.
      # The address and config (password, etc.) will be automatically used.
      device: "living-room-curtain"
      # Command to set the curtain position.
      command: "set_position"
      # `params` specifies method parameters for the command.
      params:
        position: 100 # 0 = closed, 100 = fully open

  - name: "Monitor Living Room Meter (using device alias)"
    if:
      source: "switchbot"
      # Use a device alias defined in the top-level `devices` section.
      # The `address` from the `my-meter` definition will be automatically
      # injected into `conditions.address`.
      device: "my-sensor"
      conditions:
        # If `address` is also specified here, the `device` alias's address
        # will take precedence and overwrite it.
        temperature: "> 25.0"
        humidity: "< 60.0"
    then:
      type: "log"
      message: "Living room is hot and humid! ({temperature}C, {humidity}%)"

# ----------------------------------------------------
# MQTT Client Settings
# ----------------------------------------------------
mqtt:
  # To enable the MQTT client, set `enabled` to true and configure the host.
  # This can also be controlled via the --mqtt/--no-mqtt CLI flags.
  enabled: false

  # Hostname or IP address of the MQTT broker.
  # Default: "localhost"
  host: "localhost"

  # Port number for the MQTT broker.
  # Default: 1883
  port: 1883

  # Optional: Username for authentication.
  # username: "your_username"

  # Optional: Password for authentication.
  # password: "your_password"

  # Interval in seconds to wait before attempting to reconnect.
  # Default: 10
  reconnect_interval: 10

# ----------------------------------------------------
# Prometheus Exporter Settings
# ----------------------------------------------------
prometheus:
  # Enable/disable the exporter feature.
  # Default: false (disabled)
  # Set to `true` to enable the Prometheus exporter.
  enabled: false

  # Port for the exporter to listen on.
  # Default: 8000
  port: 8000

  # Specify the devices and metrics to target.
  target:
    # Only devices with an address in this list will be targeted.
    # If this key is missing or the list is empty, all discovered devices will be targeted.
    addresses:
      #  - "00:00:5E:00:53:00"
      #  - "00:00:5E:00:53:01"

    # Only metrics in this list will be exported.
    # If this key is missing or the list is empty, all available metrics will be exported.
    metrics:
      # - "temperature"
      # - "humidity"
      # - "battery"
      # - "rssi"

# ----------------------------------------------------
# Logging Settings
# ----------------------------------------------------
logging:
  # Default log level for the application: DEBUG, INFO, WARNING, ERROR
  # This is overridden by the --debug flag.
  level: "INFO"

  # Log format, using Python's logging format syntax.
  format: "% (asctime)s - %(name)s - %(levelname)s - %(message)s"

  # Set specific log levels for noisy libraries.
  # This is useful for debugging specific components without enabling global debug.
  # These settings are ignored if the --debug flag is used.
  loggers:
    bleak: "WARNING"
    # ----------------------------------------------------
    # DEBUGGING TIP:
    # To troubleshoot why an automation rule isn't working as expected,
    # enable detailed logging for the automation engine. This will show
    # why conditions were met or not met, cooldown status, and action execution.
    # ----------------------------------------------------
    # switchbot_actions.automation: "DEBUG"
